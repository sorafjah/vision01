<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ビジョントレーニング</title>
    <!-- Tailwind CSSを読み込みます -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Googleフォント「M PLUS Rounded 1c」を読み込みます。丸みのあるフォントで、親しみやすい印象を与えます。 */
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            touch-action: none; /* スマートフォンやタブレットでのタッチ操作時に、画面が動かないようにします */
        }
        /* スライダーのつまみのスタイルを調整します */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #ffffff;
            border: 2px solid #4f46e5;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #ffffff;
            border: 2px solid #4f46e5;
            border-radius: 50%;
            cursor: pointer;
        }
        /* アクティブなモードのボタンのスタイル */
        .mode-button.active {
            background-color: #818cf8; /* 淡い紫 */
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="bg-slate-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl mx-auto flex flex-col">
        
        <!-- トップバーコンテナ -->
        <div class="w-full flex justify-center items-center order-1 mb-2 px-2 relative" style="height: 68px;">
            <!-- モード２用の情報表示 (中央) -->
            <div id="findModeInfo" class="text-center">
                <div class="inline-flex items-center gap-4 bg-white/80 backdrop-blur-sm p-3 rounded-xl shadow-sm">
                    <span id="targetText" class="text-sm font-bold text-slate-600">いっしょのタッチ→</span>
                    <div id="targetColorDisplay" class="w-10 h-10 rounded-full border-2 border-slate-400"></div>
                </div>
            </div>

             <!-- スタート・ストップボタン (右端) -->
            <button id="toggleButton" class="absolute right-2 top-1/2 -translate-y-1/2 text-sm font-bold py-2 px-4 rounded-lg bg-slate-200 text-slate-700 transition-all w-28">スタート</button>
        </div>
        
        <!-- トレーニング画面のコンテナ -->
        <div id="canvas-container" class="w-full aspect-video bg-white rounded-2xl shadow-lg overflow-hidden border-4 border-slate-200 relative order-2">
            <canvas id="trainingCanvas"></canvas>
            <!-- モード２用の情報表示は上記に移動しました -->
        </div>

        <!-- コントロールパネル -->
        <div class="w-full mt-4 bg-white p-4 rounded-2xl shadow-lg order-3">
            <div class="flex flex-wrap justify-center items-end gap-x-6 gap-y-4">
                
                <!-- モード選択ボタン -->
                <div class="flex flex-col items-center">
                    <label class="text-sm font-bold text-slate-600 mb-1 invisible">モード</label> <!-- レイアウト調整用の透明ラベル -->
                     <div class="flex gap-2">
                        <button id="modeChase" class="mode-button text-sm font-bold py-2 px-4 rounded-lg bg-slate-200 text-slate-700 transition-all w-24">よくみる</button>
                        <button id="modeFind" class="mode-button text-sm font-bold py-2 px-4 rounded-lg bg-slate-200 text-slate-700 transition-all w-24">タッチ</button>
                        <button id="modeAuto" class="mode-button text-sm font-bold py-2 px-4 rounded-lg bg-slate-200 text-slate-700 transition-all w-24">じどう</button>
                    </div>
                </div>

                <!-- モード１用コントロール -->
                <div id="chaseControls" class="contents">
                    <div class="flex flex-col items-center">
                        <label for="colorPicker" class="text-sm font-bold text-slate-600 mb-1">ボールのいろ</label>
                        <input type="color" id="colorPicker" value="#14b8a6" class="w-16 h-10 p-1 bg-white border-2 border-slate-300 rounded-lg cursor-pointer">
                    </div>
                    <div class="flex flex-col items-center">
                        <label for="bgColorPicker" class="text-sm font-bold text-slate-600 mb-1">はいけいのいろ</label>
                        <input type="color" id="bgColorPicker" value="#ffffff" class="w-16 h-10 p-1 bg-white border-2 border-slate-300 rounded-lg cursor-pointer">
                    </div>
                </div>
                 <!-- モード２＆じどう用コントロール -->
                <div id="findControls" class="contents hidden">
                     <div class="flex flex-col items-center justify-center w-24">
                        <label for="ballCountRange" class="text-sm font-bold text-slate-600 mb-1">ボールのかず</label>
                        <span id="ballCountValue" class="text-sm text-slate-500">8</span>
                        <input type="range" id="ballCountRange" min="3" max="20" value="8" class="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
                 <!-- じどうモード用コントロール -->
                <div id="autoControls" class="contents hidden">
                     <div class="flex flex-col items-center justify-center w-24">
                        <label for="autoSwitchRange" class="text-sm font-bold text-slate-600 mb-1">きりかえ</label>
                        <span id="autoSwitchValue" class="text-sm text-slate-500">5秒</span>
                        <input type="range" id="autoSwitchRange" min="2" max="10" value="5" class="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
                <!-- 共通コントロール -->
                <div class="flex flex-col items-center w-24">
                    <label for="speedRange" class="text-sm font-bold text-slate-600 mb-1">はやさ</label>
                    <span id="speedValue" class="text-sm text-slate-500">3</span>
                    <input type="range" id="speedRange" min="1" max="10" value="3" class="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="flex flex-col items-center w-24">
                    <label for="sizeRange" class="text-sm font-bold text-slate-600 mb-1">おおきさ</label>
                    <span id="sizeValue" class="text-sm text-slate-500">30</span>
                    <input type="range" id="sizeRange" min="10" max="80" value="30" class="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM要素の取得 ---
        const canvasContainer = document.getElementById('canvas-container');
        const canvas = document.getElementById('trainingCanvas');
        const ctx = canvas.getContext('2d');

        const toggleButton = document.getElementById('toggleButton');
        const modeChaseButton = document.getElementById('modeChase');
        const modeFindButton = document.getElementById('modeFind');
        const modeAutoButton = document.getElementById('modeAuto');
        
        // コントロール
        const colorPicker = document.getElementById('colorPicker');
        const speedRange = document.getElementById('speedRange');
        const sizeRange = document.getElementById('sizeRange');
        const bgColorPicker = document.getElementById('bgColorPicker');
        const ballCountRange = document.getElementById('ballCountRange');
        const autoSwitchRange = document.getElementById('autoSwitchRange');

        // スライダーの値表示
        const speedValue = document.getElementById('speedValue');
        const sizeValue = document.getElementById('sizeValue');
        const ballCountValue = document.getElementById('ballCountValue');
        const autoSwitchValue = document.getElementById('autoSwitchValue');
        
        // UI要素
        const findModeInfo = document.getElementById('findModeInfo');
        const targetColorDisplay = document.getElementById('targetColorDisplay');
        const chaseControls = document.getElementById('chaseControls');
        const findControls = document.getElementById('findControls');
        const autoControls = document.getElementById('autoControls');

        // --- グローバル変数 ---
        let animationFrameId;
        let isRunning = false;
        let gameMode = ''; 
        let autoSwitchInterval;

        // ボールオブジェクト（単数・複数）
        let ball = {}; // モード１用
        let balls = []; // モード２用
        let targetColor = ''; // モード２用
        const findModeColors = ['#ef4444', '#3b82f6', '#22c55e', '#eab308', '#8b5cf6', '#ec4899'];

        // --- 関数の定義 ---

        /**
         * Canvasのサイズを親要素に合わせて調整
         */
        function resizeCanvas() {
            canvas.width = canvasContainer.clientWidth;
            canvas.height = canvasContainer.clientHeight;
            draw(); // リサイズ時に再描画
        }

        /**
         * メインの描画関数。ゲームモードに応じて描画を切り替える
         */
        function draw() {
            // 背景をクリア
            ctx.fillStyle = bgColorPicker.value;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (gameMode === 'chase') {
                drawChaseMode();
            } else { // 'find' or 'auto'
                drawFindMode();
            }
        }
        
        /**
         * アニメーションのメインループ
         */
        function animate() {
            if (!isRunning) return;

            // 位置更新
            if (gameMode === 'chase') {
                updateChaseMode();
            } else {
                updateFindMode();
            }
            // 描画
            draw();
            
            animationFrameId = requestAnimationFrame(animate);
        }
        
        /**
         * スタート・ストップを切り替える
         */
        function toggleAnimation() {
            if (isRunning) {
                stopAnimation();
            } else {
                startAnimation();
            }
        }

        /**
         * アニメーションを開始
         */
        function startAnimation() {
            if (!isRunning) {
                isRunning = true;
                toggleButton.textContent = 'ストップ';
                toggleButton.classList.remove('bg-slate-200', 'text-slate-700');
                toggleButton.classList.add('bg-pink-400', 'text-white');

                if ((gameMode === 'find' || gameMode === 'auto') && balls.length === 0) {
                    initFindMode();
                }

                if (gameMode === 'auto') {
                    const switchTime = parseInt(autoSwitchRange.value, 10) * 1000;
                    autoSwitchInterval = setInterval(() => {
                        initFindMode();
                        if(!isRunning) draw(); // アニメーションが止まっていても描画は更新
                    }, switchTime);
                }

                animate();
            }
        }

        /**
         * アニメーションを停止
         */
        function stopAnimation() {
            if (isRunning) {
                isRunning = false;
                toggleButton.textContent = 'スタート';
                toggleButton.classList.remove('bg-pink-400', 'text-white');
                toggleButton.classList.add('bg-slate-200', 'text-slate-700');
                clearInterval(autoSwitchInterval);
                cancelAnimationFrame(animationFrameId);
                draw(); // 停止した状態を再描画
            }
        }
        
        /**
         * ゲームモードを切り替える
         * @param {string} newMode - 'chase', 'find', or 'auto'
         */
        function switchMode(newMode) {
            if(gameMode === newMode) return;
            stopAnimation();
            gameMode = newMode;
            
            // 全てのボタンとコントロールを一旦リセット
            [modeChaseButton, modeFindButton, modeAutoButton].forEach(btn => btn.classList.remove('active'));
            [chaseControls, findControls, autoControls].forEach(ctrl => ctrl.classList.add('hidden'));
            findModeInfo.style.visibility = 'hidden';

            if (newMode === 'chase') {
                modeChaseButton.classList.add('active');
                chaseControls.classList.remove('hidden');
                initChaseMode();
            } else if (newMode === 'find') {
                modeFindButton.classList.add('active');
                findControls.classList.remove('hidden');
                findModeInfo.style.visibility = 'visible';
                initFindMode();
            } else if (newMode === 'auto') {
                modeAutoButton.classList.add('active');
                findControls.classList.remove('hidden'); // ボールのかずは共通
                autoControls.classList.remove('hidden');
                findModeInfo.style.visibility = 'visible';
                initFindMode();
            }
            draw();
        }

        // --- モード１：よくみる ---
        function initChaseMode() {
            const speed = parseFloat(speedRange.value);
            ball = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                radius: parseInt(sizeRange.value, 10),
                color: colorPicker.value,
                dx: speed * (Math.random() > 0.5 ? 1 : -1),
                dy: speed * (Math.random() > 0.5 ? 1 : -1)
            };
        }

        function drawChaseMode() {
            if (!ball.radius) return;
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = ball.color;
            ctx.fill();
            ctx.closePath();
        }

        function updateChaseMode() {
            if (!ball.radius) initChaseMode(); // 安全策
            ball.x += ball.dx;
            ball.y += ball.dy;
            if (ball.x + ball.radius > canvas.width || ball.x - ball.radius < 0) ball.dx *= -1;
            if (ball.y + ball.radius > canvas.height || ball.y - ball.radius < 0) ball.dy *= -1;
        }

        // --- モード２＆じどう ---
        function initFindMode() {
            balls = [];
            targetColor = findModeColors[Math.floor(Math.random() * findModeColors.length)];
            targetColorDisplay.style.backgroundColor = targetColor;
            
            const ballCount = parseInt(ballCountRange.value, 10);
            const radius = parseInt(sizeRange.value, 10);
            const speed = parseFloat(speedRange.value);

            // 必ず1つはターゲット色のボールを作成
            balls.push(createBall(radius, speed, targetColor));
            
            // 残りのボールを作成
            for (let i = 0; i < ballCount - 1; i++) {
                let color = findModeColors[Math.floor(Math.random() * findModeColors.length)];
                if (color === targetColor && ballCount < findModeColors.length * 2) {
                    color = findModeColors[(findModeColors.indexOf(color) + 1) % findModeColors.length];
                }
                balls.push(createBall(radius, speed, color));
            }
        }
        
        function createBall(radius, speed, color) {
            const angle = Math.random() * Math.PI * 2;
            return {
                x: Math.random() * (canvas.width - radius * 2) + radius,
                y: Math.random() * (canvas.height - radius * 2) + radius,
                radius: radius,
                color: color,
                dx: Math.cos(angle) * speed,
                dy: Math.sin(angle) * speed
            };
        }

        function drawFindMode() {
            balls.forEach(b => {
                ctx.beginPath();
                ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);
                ctx.fillStyle = b.color;
                ctx.fill();
                ctx.closePath();
            });
        }

        function updateFindMode() {
            balls.forEach(b => {
                b.x += b.dx;
                b.y += b.dy;
                if (b.x + b.radius > canvas.width || b.x - b.radius < 0) b.dx *= -1;
                if (b.y + b.radius > canvas.height || b.y - b.radius < 0) b.dy *= -1;
            });
        }
        
        function handleCanvasClick(event) {
            // ★修正点：'じどう'モードでもクリックを有効にする
            if ((gameMode !== 'find' && gameMode !== 'auto') || !isRunning) return;

            const rect = canvas.getBoundingClientRect();
            const clientX = event.clientX || event.touches[0].clientX;
            const clientY = event.clientY || event.touches[0].clientY;
            const x = clientX - rect.left;
            const y = clientY - rect.top;

            for (let i = balls.length - 1; i >= 0; i--) {
                const b = balls[i];
                const distance = Math.sqrt((x - b.x)**2 + (y - b.y)**2);
                if (distance < b.radius) {
                    if (b.color === targetColor) {
                        // ★修正点：正解時に新しいセットを開始する
                        initFindMode(); 
                        
                        // 'じどう'モードの場合は、タイマーをリセットする
                        if (gameMode === 'auto') {
                            clearInterval(autoSwitchInterval);
                            const switchTime = parseInt(autoSwitchRange.value, 10) * 1000;
                            autoSwitchInterval = setInterval(() => {
                                initFindMode();
                                if(!isRunning) draw(); 
                            }, switchTime);
                        }
                        
                        draw(); // すぐに再描画
                    }
                    return; // 1回のクリックで1つのボールのみ判定
                }
            }
        }

        // --- イベントリスナーの設定 ---
        toggleButton.addEventListener('click', toggleAnimation);
        modeChaseButton.addEventListener('click', () => switchMode('chase'));
        modeFindButton.addEventListener('click', () => switchMode('find'));
        modeAutoButton.addEventListener('click', () => switchMode('auto'));

        canvas.addEventListener('click', handleCanvasClick);
        canvas.addEventListener('touchstart', handleCanvasClick);
        
        // コントロールのイベントリスナー
        colorPicker.addEventListener('input', (e) => {
            if (gameMode === 'chase') {
                ball.color = e.target.value;
                if (!isRunning) draw();
            }
        });
        bgColorPicker.addEventListener('input', (e) => {
            if (!isRunning) draw();
        });
        
        function updateSpeed() {
            const speed = parseFloat(speedRange.value);
            speedValue.textContent = speed;
            const updateTarget = (gameMode === 'chase') ? [ball] : balls;
            
            updateTarget.forEach(b => {
                if(!b || (b.dx === 0 && b.dy === 0)) return;
                const currentSpeed = Math.sqrt(b.dx * b.dx + b.dy * b.dy);
                if (currentSpeed > 0) {
                    const ratio = speed / currentSpeed;
                    b.dx *= ratio;
                    b.dy *= ratio;
                }
            });
        }
        speedRange.addEventListener('input', updateSpeed);

        function updateSize() {
            const radius = parseInt(sizeRange.value, 10);
            sizeValue.textContent = radius;
            const updateTarget = (gameMode === 'chase') ? [ball] : balls;
            updateTarget.forEach(b => { if(b) b.radius = radius; });
            if (!isRunning) draw();
        }
        sizeRange.addEventListener('input', updateSize);
        
        ballCountRange.addEventListener('input', (e) => {
            ballCountValue.textContent = e.target.value;
            if ((gameMode === 'find' || gameMode === 'auto') && !isRunning) {
                initFindMode();
                draw();
            }
        });

        autoSwitchRange.addEventListener('input', (e) => {
            autoSwitchValue.textContent = `${e.target.value}秒`;
            if (isRunning && gameMode === 'auto') {
                clearInterval(autoSwitchInterval);
                const switchTime = parseInt(e.target.value, 10) * 1000;
                autoSwitchInterval = setInterval(() => {
                    initFindMode();
                    if(!isRunning) draw();
                }, switchTime);
            }
        });

        window.addEventListener('resize', resizeCanvas);

        // --- 初期化処理 ---
        function initialize() {
            resizeCanvas();
            switchMode('chase'); // 最初は「よくみる」モードで開始
        }

        window.onload = initialize;
    </script>
</body>
</html>

