<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ビジョントレーニング</title>
    <!-- Tailwind CSSを読み込みます -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js（音声ライブラリ）を読み込みます -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* Googleフォント「M PLUS Rounded 1c」を読み込みます。丸みのあるフォントで、親しみやすい印象を与えます。 */
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            touch-action: manipulation; /* ダブルタップによるズームを無効化し、ボタン操作を快適にします */
            -webkit-user-select: none; /* テキスト選択を無効化 */
            user-select: none;
        }
        /* アクティブなモードのボタンのスタイル */
        .mode-button.active {
            background-color: #818cf8; /* 淡い紫 */
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* コントロールボタンのスタイル */
        .control-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #e2e8f0; /* slate-200 */
            color: #475569; /* slate-600 */
            font-size: 1.5rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .control-button:active {
            background-color: #cbd5e1; /* slate-300 */
        }
        .control-value {
            font-size: 1.125rem; /* text-lg */
            font-weight: 700;
            color: #475569; /* slate-600 */
            width: 40px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-slate-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl mx-auto flex flex-col">
        
        <!-- トップバーコンテナ -->
        <div class="w-full flex justify-center items-center order-1 mb-2 px-2 relative" style="height: 68px;">
            <!-- モード２用の情報表示 (中央) -->
            <div id="findModeInfo" class="text-center">
                <div class="inline-flex items-center gap-4 bg-white/80 backdrop-blur-sm p-3 rounded-xl shadow-sm">
                    <span id="targetText" class="text-sm font-bold text-slate-600">いっしょのタッチ→</span>
                    <div id="targetColorDisplay" class="w-10 h-10 rounded-full border-2 border-slate-400"></div>
                </div>
            </div>

             <!-- スタート・ストップボタン (右端) -->
            <button id="toggleButton" class="absolute right-2 top-1/2 -translate-y-1/2 text-sm font-bold py-2 px-4 rounded-lg bg-slate-200 text-slate-700 transition-all w-28">スタート</button>
        </div>
        
        <!-- トレーニング画面のコンテナ -->
        <div id="canvas-container" class="w-full aspect-video bg-white rounded-2xl shadow-lg overflow-hidden border-4 border-slate-200 relative order-2">
            <canvas id="trainingCanvas"></canvas>
        </div>

        <!-- コントロールパネル -->
        <div class="w-full mt-4 bg-white p-4 rounded-2xl shadow-lg order-3">
            <div class="grid grid-cols-2 sm:grid-cols-3 md:flex md:flex-wrap justify-center items-center gap-x-6 gap-y-6">
                
                <!-- モード選択ボタン -->
                <div class="flex flex-col items-center col-span-2 sm:col-span-3 md:order-1">
                     <div class="flex gap-2">
                         <button id="modeChase" class="mode-button text-sm font-bold py-2 px-4 rounded-lg bg-slate-200 text-slate-700 transition-all w-24">よくみる</button>
                         <button id="modeFind" class="mode-button text-sm font-bold py-2 px-4 rounded-lg bg-slate-200 text-slate-700 transition-all w-24">タッチ</button>
                         <button id="modeAuto" class="mode-button text-sm font-bold py-2 px-4 rounded-lg bg-slate-200 text-slate-700 transition-all w-24">じどう</button>
                     </div>
                </div>

                <!-- モード１用コントロール -->
                <div id="chaseControls" class="contents">
                    <div class="flex flex-col items-center md:order-2">
                        <label for="colorPicker" class="text-sm font-bold text-slate-600 mb-2">ボールのいろ</label>
                        <input type="color" id="colorPicker" value="#14b8a6" class="w-16 h-10 p-1 bg-white border-2 border-slate-300 rounded-lg cursor-pointer">
                    </div>
                    <div class="flex flex-col items-center md:order-3">
                        <label for="bgColorPicker" class="text-sm font-bold text-slate-600 mb-2">はいけいのいろ</label>
                        <input type="color" id="bgColorPicker" value="#ffffff" class="w-16 h-10 p-1 bg-white border-2 border-slate-300 rounded-lg cursor-pointer">
                    </div>
                </div>
                 <!-- モード２＆じどう用コントロール -->
                <div id="findControls" class="contents hidden">
                     <div class="flex flex-col items-center justify-center md:order-4">
                         <label class="text-sm font-bold text-slate-600 mb-2">ボールのかず</label>
                         <div class="flex items-center gap-2">
                            <button id="ballCountDecrement" class="control-button">-</button>
                            <span id="ballCountValue" class="control-value">8</span>
                            <button id="ballCountIncrement" class="control-button">+</button>
                         </div>
                     </div>
                </div>
                 <!-- じどうモード用コントロール -->
                <div id="autoControls" class="contents hidden">
                     <div class="flex flex-col items-center justify-center md:order-5">
                         <label class="text-sm font-bold text-slate-600 mb-2">きりかえ</label>
                          <div class="flex items-center gap-2">
                            <button id="autoSwitchDecrement" class="control-button">-</button>
                            <span id="autoSwitchValue" class="control-value">5</span>
                            <button id="autoSwitchIncrement" class="control-button">+</button>
                         </div>
                     </div>
                </div>
                <!-- 共通コントロール -->
                <div class="flex flex-col items-center md:order-6">
                    <label class="text-sm font-bold text-slate-600 mb-2">はやさ</label>
                     <div class="flex items-center gap-2">
                        <button id="speedDecrement" class="control-button">-</button>
                        <span id="speedValue" class="control-value">3</span>
                        <button id="speedIncrement" class="control-button">+</button>
                    </div>
                </div>
                <div class="flex flex-col items-center md:order-7">
                    <label class="text-sm font-bold text-slate-600 mb-2">おおきさ</label>
                     <div class="flex items-center gap-2">
                        <button id="sizeDecrement" class="control-button">-</button>
                        <span id="sizeValue" class="control-value">30</span>
                        <button id="sizeIncrement" class="control-button">+</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM要素の取得 ---
        const canvasContainer = document.getElementById('canvas-container');
        const canvas = document.getElementById('trainingCanvas');
        const ctx = canvas.getContext('2d');

        const toggleButton = document.getElementById('toggleButton');
        const modeChaseButton = document.getElementById('modeChase');
        const modeFindButton = document.getElementById('modeFind');
        const modeAutoButton = document.getElementById('modeAuto');
        
        // コントロール
        const colorPicker = document.getElementById('colorPicker');
        const bgColorPicker = document.getElementById('bgColorPicker');

        // 値表示
        const speedValue = document.getElementById('speedValue');
        const sizeValue = document.getElementById('sizeValue');
        const ballCountValue = document.getElementById('ballCountValue');
        const autoSwitchValue = document.getElementById('autoSwitchValue');

        // UI要素
        const findModeInfo = document.getElementById('findModeInfo');
        const targetColorDisplay = document.getElementById('targetColorDisplay');
        const chaseControls = document.getElementById('chaseControls');
        const findControls = document.getElementById('findControls');
        const autoControls = document.getElementById('autoControls');

        // --- 設定値の変数 ---
        const settings = {
            ballCount: { value: 8, min: 3, max: 20, element: ballCountValue },
            autoSwitch: { value: 5, min: 2, max: 10, element: autoSwitchValue },
            speed: { value: 3, min: 1, max: 10, element: speedValue },
            size: { value: 30, min: 10, max: 80, element: sizeValue, step: 5 },
        };
        
        // --- グローバル変数 ---
        let animationFrameId;
        let isRunning = false;
        let gameMode = ''; 
        let autoSwitchInterval;

        // ボールオブジェクト
        let ball = {}; // モード１用
        let balls = []; // モード２用
        let targetColor = ''; // モード２用
        const findModeColors = ['#ef4444', '#3b82f6', '#22c55e', '#eab308', '#8b5cf6', '#ec4899'];

        // --- 効果音の準備 ---
        const synths = {
            '#ef4444': new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.5 } }).toDestination(), // 赤 - ぴょん
            '#3b82f6': new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.2, sustain: 0.1, release: 0.5 } }).toDestination(),     // 青 - ぽよん
            '#22c55e': new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.4 } }).toDestination(),   // 緑 - ぴこ
            '#eab308': new Tone.FMSynth({ harmonicity: 1.5, modulationIndex: 10, oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 } }).toDestination(), // 黄 - チャリン
            '#8b5cf6': new Tone.AMSynth({ harmonicity: 3, oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 0.5 }}).toDestination(), // 紫 - きらーん
            '#ec4899': new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 10, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4, attackCurve: 'exponential' } }).toDestination() // ピンク - ぽん
        };
        const soundNotes = {
            '#ef4444': 'C5', '#3b82f6': 'E5', '#22c55e': 'G5',
            '#eab308': 'A5', '#8b5cf6': 'B5', '#ec4899': 'C4'
        };

        function playSound(color) {
            if (synths[color] && soundNotes[color]) {
                synths[color].triggerAttackRelease(soundNotes[color], '8n');
            }
        }


        // --- 関数の定義 ---

        /**
         * Canvasのサイズを親要素に合わせて調整
         */
        function resizeCanvas() {
            canvas.width = canvasContainer.clientWidth;
            canvas.height = canvasContainer.clientHeight;
            draw(); // リサイズ時に再描画
        }

        /**
         * メインの描画関数
         */
        function draw() {
            ctx.fillStyle = bgColorPicker.value;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (gameMode === 'chase') {
                drawChaseMode();
            } else { // 'find' or 'auto'
                drawFindMode();
            }
        }
        
        /**
         * アニメーションのメインループ
         */
        function animate() {
            if (!isRunning) return;
            if (gameMode === 'chase') {
                updateChaseMode();
            } else {
                updateFindMode();
            }
            draw();
            animationFrameId = requestAnimationFrame(animate);
        }
        
        /**
         * スタート・ストップを切り替える
         */
        function toggleAnimation() {
            if (isRunning) {
                stopAnimation();
            } else {
                startAnimation();
            }
        }

        /**
         * アニメーションを開始
         */
        async function startAnimation() {
            if (!isRunning) {
                // Tone.jsのオーディオコンテキストを開始
                await Tone.start();
                console.log('Audio is ready');

                isRunning = true;
                toggleButton.textContent = 'ストップ';
                toggleButton.classList.remove('bg-slate-200', 'text-slate-700');
                toggleButton.classList.add('bg-pink-400', 'text-white');

                if ((gameMode === 'find' || gameMode === 'auto') && balls.length === 0) {
                    initFindMode();
                }

                if (gameMode === 'auto') {
                    startAutoSwitchTimer();
                }

                animate();
            }
        }

        /**
         * アニメーションを停止
         */
        function stopAnimation() {
            if (isRunning) {
                isRunning = false;
                toggleButton.textContent = 'スタート';
                toggleButton.classList.remove('bg-pink-400', 'text-white');
                toggleButton.classList.add('bg-slate-200', 'text-slate-700');
                clearInterval(autoSwitchInterval);
                cancelAnimationFrame(animationFrameId);
                draw(); // 停止した状態を再描画
            }
        }
        
        /**
         * ゲームモードを切り替える
         */
        function switchMode(newMode) {
            if(gameMode === newMode) return;
            stopAnimation();
            gameMode = newMode;
            
            [modeChaseButton, modeFindButton, modeAutoButton].forEach(btn => btn.classList.remove('active'));
            [chaseControls, findControls, autoControls].forEach(ctrl => ctrl.classList.add('hidden'));
            findModeInfo.style.visibility = 'hidden';

            if (newMode === 'chase') {
                modeChaseButton.classList.add('active');
                chaseControls.classList.remove('hidden');
                initChaseMode();
            } else if (newMode === 'find') {
                modeFindButton.classList.add('active');
                findControls.classList.remove('hidden');
                findModeInfo.style.visibility = 'visible';
                initFindMode();
            } else if (newMode === 'auto') {
                modeAutoButton.classList.add('active');
                findControls.classList.remove('hidden');
                autoControls.classList.remove('hidden');
                findModeInfo.style.visibility = 'visible';
                initFindMode();
            }
            draw();
        }

        // --- モード１：よくみる ---
        function initChaseMode() {
            const speed = settings.speed.value;
            ball = {
                x: canvas.width / 2, y: canvas.height / 2,
                radius: settings.size.value, color: colorPicker.value,
                dx: speed * (Math.random() > 0.5 ? 1 : -1),
                dy: speed * (Math.random() > 0.5 ? 1 : -1)
            };
        }

        function drawChaseMode() {
            if (!ball.radius) return;
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = ball.color;
            ctx.fill();
            ctx.closePath();
        }

        function updateChaseMode() {
            if (!ball.radius) initChaseMode();
            ball.x += ball.dx;
            ball.y += ball.dy;
            if (ball.x + ball.radius > canvas.width || ball.x - ball.radius < 0) ball.dx *= -1;
            if (ball.y + ball.radius > canvas.height || ball.y - ball.radius < 0) ball.dy *= -1;
        }

        // --- モード２＆じどう ---
        function initFindMode() {
            balls = [];
            targetColor = findModeColors[Math.floor(Math.random() * findModeColors.length)];
            targetColorDisplay.style.backgroundColor = targetColor;
            
            const ballCount = settings.ballCount.value;
            const radius = settings.size.value;
            const speed = settings.speed.value;

            balls.push(createBall(radius, speed, targetColor));
            
            for (let i = 0; i < ballCount - 1; i++) {
                let color = findModeColors[Math.floor(Math.random() * findModeColors.length)];
                if (color === targetColor && ballCount < findModeColors.length * 2) {
                    color = findModeColors[(findModeColors.indexOf(color) + 1) % findModeColors.length];
                }
                balls.push(createBall(radius, speed, color));
            }
        }
        
        function createBall(radius, speed, color) {
            const angle = Math.random() * Math.PI * 2;
            return {
                x: Math.random() * (canvas.width - radius * 2) + radius,
                y: Math.random() * (canvas.height - radius * 2) + radius,
                radius: radius, color: color,
                dx: Math.cos(angle) * speed,
                dy: Math.sin(angle) * speed
            };
        }

        function drawFindMode() {
            balls.forEach(b => {
                ctx.beginPath();
                ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);
                ctx.fillStyle = b.color;
                ctx.fill();
                ctx.closePath();
            });
        }

        function updateFindMode() {
            balls.forEach(b => {
                b.x += b.dx; b.y += b.dy;
                if (b.x + b.radius > canvas.width || b.x - b.radius < 0) b.dx *= -1;
                if (b.y + b.radius > canvas.height || b.y - b.radius < 0) b.dy *= -1;
            });
        }
        
        function handleCanvasClick(event) {
            if ((gameMode !== 'find' && gameMode !== 'auto') || !isRunning) return;

            event.preventDefault(); // touchstartでの画面スクロールを防止

            const rect = canvas.getBoundingClientRect();
            const clientX = event.clientX || event.touches[0].clientX;
            const clientY = event.clientY || event.touches[0].clientY;
            const x = clientX - rect.left;
            const y = clientY - rect.top;

            for (let i = balls.length - 1; i >= 0; i--) {
                const b = balls[i];
                const distance = Math.sqrt((x - b.x)**2 + (y - b.y)**2);
                if (distance < b.radius) {
                    if (b.color === targetColor) {
                        playSound(b.color); // 正解の音を鳴らす
                        initFindMode(); 
                        
                        if (gameMode === 'auto') {
                            resetAutoSwitchTimer();
                        }
                        
                        draw(); // すぐに再描画
                    }
                    return; // 1回のクリックで1つのボールのみ判定
                }
            }
        }

        // --- コントロール更新関数 ---
        function updateSetting(settingName, change) {
            const setting = settings[settingName];
            const step = setting.step || 1;
            let newValue = setting.value + change * step;

            // 最小値・最大値の制限
            newValue = Math.max(setting.min, Math.min(setting.max, newValue));
            
            if (newValue !== setting.value) {
                setting.value = newValue;
                setting.element.textContent = newValue;

                // 各設定に応じた処理を実行
                switch (settingName) {
                    case 'speed': updateSpeed(); break;
                    case 'size': updateSize(); break;
                    case 'ballCount':
                        if ((gameMode === 'find' || gameMode === 'auto') && !isRunning) {
                            initFindMode();
                            draw();
                        }
                        break;
                    case 'autoSwitch':
                        if (isRunning && gameMode === 'auto') {
                            resetAutoSwitchTimer();
                        }
                        break;
                }
            }
        }

        function updateSpeed() {
            const speed = settings.speed.value;
            const updateTarget = (gameMode === 'chase') ? [ball] : balls;
            
            updateTarget.forEach(b => {
                if(!b || (b.dx === 0 && b.dy === 0)) return;
                const currentSpeed = Math.sqrt(b.dx * b.dx + b.dy * b.dy);
                if (currentSpeed > 0) {
                    const ratio = speed / currentSpeed;
                    b.dx *= ratio;
                    b.dy *= ratio;
                }
            });
        }
        function updateSize() {
            const radius = settings.size.value;
            const updateTarget = (gameMode === 'chase') ? [ball] : balls;
            updateTarget.forEach(b => { if(b) b.radius = radius; });
            if (!isRunning) draw();
        }

        function startAutoSwitchTimer() {
             const switchTime = settings.autoSwitch.value * 1000;
             autoSwitchInterval = setInterval(() => {
                initFindMode();
                if(!isRunning) draw();
            }, switchTime);
        }

        function resetAutoSwitchTimer() {
            clearInterval(autoSwitchInterval);
            startAutoSwitchTimer();
        }


        // --- イベントリスナーの設定 ---
        toggleButton.addEventListener('click', toggleAnimation);
        modeChaseButton.addEventListener('click', () => switchMode('chase'));
        modeFindButton.addEventListener('click', () => switchMode('find'));
        modeAutoButton.addEventListener('click', () => switchMode('auto'));

        canvas.addEventListener('click', handleCanvasClick);
        canvas.addEventListener('touchstart', handleCanvasClick, { passive: false });
        
        colorPicker.addEventListener('input', (e) => {
            if (gameMode === 'chase') {
                ball.color = e.target.value;
                if (!isRunning) draw();
            }
        });
        bgColorPicker.addEventListener('input', (e) => {
            if (!isRunning) draw();
        });
        
        // +/- ボタンのイベントリスナー
        document.getElementById('ballCountIncrement').addEventListener('click', () => updateSetting('ballCount', 1));
        document.getElementById('ballCountDecrement').addEventListener('click', () => updateSetting('ballCount', -1));
        document.getElementById('autoSwitchIncrement').addEventListener('click', () => updateSetting('autoSwitch', 1));
        document.getElementById('autoSwitchDecrement').addEventListener('click', () => updateSetting('autoSwitch', -1));
        document.getElementById('speedIncrement').addEventListener('click', () => updateSetting('speed', 1));
        document.getElementById('speedDecrement').addEventListener('click', () => updateSetting('speed', -1));
        document.getElementById('sizeIncrement').addEventListener('click', () => updateSetting('size', 1));
        document.getElementById('sizeDecrement').addEventListener('click', () => updateSetting('size', -1));

        window.addEventListener('resize', resizeCanvas);

        // --- 初期化処理 ---
        function initialize() {
            // 初期値を画面に表示
            for (const key in settings) {
                settings[key].element.textContent = settings[key].value;
            }
            resizeCanvas();
            switchMode('chase'); // 最初は「よくみる」モードで開始
        }

        window.onload = initialize;
    </script>
</body>
</html>
